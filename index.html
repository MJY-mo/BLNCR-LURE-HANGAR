<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BLNCR LURE HANGAR</title>
    
    <!-- ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ãƒ»ã‚¢ãƒ—ãƒªã‚¢ã‚¤ã‚³ãƒ³è¨­å®š -->
    <!-- ãƒ–ãƒ©ã‚¦ã‚¶ã‚¿ãƒ–ç”¨ (32x32ãªã©) -->
    <link rel="icon" type="image/png" href="favicon.png">
    <!-- iOS/ã‚¹ãƒãƒ›ãƒ›ãƒ¼ãƒ ç”»é¢ç”¨ (è‡ªå‹•çš„ã«ãƒªã‚µã‚¤ã‚ºã•ã‚Œã¾ã™) -->
    <link rel="apple-touch-icon" href="icon-512.png">
    <!-- Android/PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç”¨ (512x512) -->
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
        :root {
            --app-bg-color: #f3f4f6;
            --app-font-scale: 100%;
        }

        body { 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            background-color: #333;
            padding-bottom: 80px;
            font-size: var(--app-font-scale);
        }

        /* ã‚¢ãƒ—ãƒªã®ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        #app {
            background-color: var(--app-bg-color);
            transition: background-color 0.3s ease;
        }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

        .image-preview {
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 20.5V18H0v-2h20v-2H0v-2h20v-2H0V8h20V6H0V4h20V2H0V0h22v22h-2z' fill='%239C92AC' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.95); transition: all 0.2s ease-in; }

        .hidden-input { display: none; }
    </style>
</head>
<body class="text-gray-800 font-sans antialiased h-screen overflow-hidden flex justify-center bg-gray-900">

    <div id="app" class="w-full max-w-md h-full shadow-xl overflow-hidden relative flex flex-col mx-auto">
        
        <!-- Header -->
        <header class="bg-slate-800 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-md shrink-0">
            <h1 class="text-lg font-bold tracking-wider"><i class="fa-solid fa-fish-fins mr-2"></i>BLNCR LURE HANGAR</h1>
            <div id="header-actions"></div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="p-4 overflow-y-auto grow">
            <!-- Dynamic Content -->
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around items-center pb-safe max-w-md mx-auto z-50 h-16 shrink-0">
            <button onclick="router.navigate('home')" class="nav-btn flex-1 h-full text-center text-gray-500 hover:text-blue-600 focus:text-blue-600 transition" data-target="home">
                <div class="flex flex-col items-center justify-center h-full">
                    <i class="fa-solid fa-layer-group text-xl mb-1"></i>
                    <span class="text-[10px]">ãƒœãƒƒã‚¯ã‚¹</span>
                </div>
            </button>
            <button onclick="router.navigate('analysis')" class="nav-btn flex-1 h-full text-center text-gray-500 hover:text-blue-600 focus:text-blue-600 transition" data-target="analysis">
                <div class="flex flex-col items-center justify-center h-full">
                    <i class="fa-solid fa-chart-line text-xl mb-1"></i>
                    <span class="text-[10px]">åˆ†æ</span>
                </div>
            </button>
            <button onclick="router.navigate('notes')" class="nav-btn flex-1 h-full text-center text-gray-500 hover:text-blue-600 focus:text-blue-600 transition" data-target="notes">
                <div class="flex flex-col items-center justify-center h-full">
                    <i class="fa-solid fa-triangle-exclamation text-xl mb-1"></i>
                    <span class="text-[10px]">æ³¨æ„</span>
                </div>
            </button>
            <button onclick="router.navigate('settings')" class="nav-btn flex-1 h-full text-center text-gray-500 hover:text-blue-600 focus:text-blue-600 transition" data-target="settings">
                <div class="flex flex-col items-center justify-center h-full">
                    <i class="fa-solid fa-sliders text-xl mb-1"></i>
                    <span class="text-[10px]">è¨­å®š</span>
                </div>
            </button>
        </nav>

        <!-- Modal Overlay -->
        <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4">
            <div id="modal-container" class="bg-white rounded-lg w-full max-h-[90vh] overflow-y-auto shadow-2xl transform transition-all"></div>
        </div>
        
        <!-- Toast -->
        <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg z-[70] transition-opacity duration-300 opacity-0 pointer-events-none text-sm">
            Notification
        </div>

    </div>

    <!-- Logic -->
    <script>
        /**
         * ------------------------------------------------------------------
         * Utils
         * ------------------------------------------------------------------
         */
        const Utils = {
            uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
            
            compressImage: (file, maxWidth = 800, quality = 0.7) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            let width = img.width;
                            let height = img.height;
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.onerror = (err) => reject(err);
                    };
                    reader.onerror = (err) => reject(err);
                });
            },

            formatDate: (ts) => {
                if(!ts) return '';
                const d = new Date(ts);
                return isNaN(d.getTime()) ? ts : d.toLocaleDateString('ja-JP');
            },

            getTodayString: () => {
                const d = new Date();
                const month = ('0' + (d.getMonth() + 1)).slice(-2);
                const day = ('0' + d.getDate()).slice(-2);
                return `${d.getFullYear()}-${month}-${day}`;
            },

            showToast: (msg) => {
                const toast = document.getElementById('toast');
                toast.textContent = msg;
                toast.classList.remove('opacity-0');
                setTimeout(() => toast.classList.add('opacity-0'), 3000);
            }
        };

        /**
         * ------------------------------------------------------------------
         * DataManager
         * ------------------------------------------------------------------
         */
        class DataManager {
            constructor() {
                this.STORAGE_KEY = 'lure_hangar_v2_1_data';
                this.data = this.load() || this.getInitialData();
                if(!this.data.settings) {
                    this.data.settings = { fontSize: 'medium', bgColor: '#f3f4f6' };
                    this.save();
                }
            }

            getInitialData() {
                return {
                    boxes: [],
                    lures: [],
                    master: {
                        manufacturers: ['Daiwa', 'Shimano'],
                        types: ['ãƒŸãƒãƒ¼', 'ãƒšãƒ³ã‚·ãƒ«', 'ãƒãƒƒãƒ‘ãƒ¼', 'ã‚¯ãƒ©ãƒ³ã‚¯', 'ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', 'ã‚¹ãƒ”ãƒŠãƒ¼', 'ã‚¹ãƒ—ãƒ¼ãƒ³', 'ã‚¸ã‚°'],
                        sinkTypes: ['F (ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)', 'S (ã‚·ãƒ³ã‚­ãƒ³ã‚°)', 'SP (ã‚µã‚¹ãƒšãƒ³ãƒ‰)', 'HS (ãƒ˜ãƒ“ãƒ¼ã‚·ãƒ³ã‚­ãƒ³ã‚°)'],
                        fields: ['æ¸“æµ', 'ãƒªãƒãƒ¼', 'ã‚µãƒ¼ãƒ•', 'ãƒ­ãƒƒã‚¯', 'ã‚·ãƒ§ã‚¢', 'ã‚ªãƒ•ã‚·ãƒ§ã‚¢'],
                        targets: ['ãƒˆãƒ©ã‚¦ãƒˆ', 'ãƒã‚¹', 'ã‚·ãƒ¼ãƒã‚¹', 'ãƒ•ãƒ©ãƒƒãƒˆ', 'ãƒ¡ãƒãƒ«', 'é’ç‰©', 'ãƒ­ãƒƒã‚¯ãƒ•ã‚£ãƒƒã‚·ãƒ¥']
                    },
                    settings: {
                        fontSize: 'medium',
                        bgColor: '#f3f4f6' 
                    }
                };
            }

            load() {
                const json = localStorage.getItem(this.STORAGE_KEY);
                return json ? JSON.parse(json) : null;
            }

            save() {
                try {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.data));
                } catch (e) {
                    alert('å®¹é‡ã‚ªãƒ¼ãƒãƒ¼ã§ã™ã€‚ç”»åƒã‚’å‰Šé™¤ã™ã‚‹ã‹ã€ç”»è³ªã‚’ä¸‹ã’ã¦ãã ã•ã„ã€‚');
                    console.error(e);
                }
            }

            addBox(box) {
                this.data.boxes.unshift(box);
                this.save();
            }
            updateBox(updatedBox) {
                const index = this.data.boxes.findIndex(b => b.id === updatedBox.id);
                if (index !== -1) {
                    this.data.boxes[index] = updatedBox;
                    this.save();
                }
            }
            deleteBox(id) {
                this.data.boxes = this.data.boxes.filter(b => b.id !== id);
                this.data.lures = this.data.lures.filter(l => l.boxId !== id);
                this.save();
            }
            getBox(id) { return this.data.boxes.find(b => b.id === id); }
            getAllTags() {
                const tags = new Set();
                this.data.boxes.forEach(b => (b.tags || []).forEach(t => tags.add(t)));
                return Array.from(tags).sort();
            }

            addLure(lure) {
                this.data.lures.push(lure);
                this.save();
            }
            deleteLure(id) {
                this.data.lures = this.data.lures.filter(l => l.id !== id);
                this.save();
            }
            getLuresByBoxId(boxId) { return this.data.lures.filter(l => l.boxId === boxId); }
            getAllLures() { return this.data.lures; }

            updateMaster(key, list) {
                if (this.data.master[key]) {
                    this.data.master[key] = list;
                    this.save();
                }
            }
            updateSettings(settings) {
                this.data.settings = { ...this.data.settings, ...settings };
                this.save();
            }

            exportData() {
                const json = JSON.stringify(this.data);
                const blob = new Blob([json], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lure_hangar_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            }
            importData(jsonString) {
                try {
                    const parsed = JSON.parse(jsonString);
                    if (parsed.boxes && parsed.lures) {
                        this.data = parsed;
                        this.save();
                        return true;
                    }
                } catch (e) { console.error(e); }
                return false;
            }
        }

        /**
         * ------------------------------------------------------------------
         * AppRouter
         * ------------------------------------------------------------------
         */
        class AppRouter {
            constructor(ui) {
                this.ui = ui;
                this.currentRoute = 'home';
            }

            navigate(route, params = null) {
                this.currentRoute = route;
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    const target = btn.dataset.target;
                    if (target === route) {
                        btn.classList.add('text-blue-600');
                        btn.classList.remove('text-gray-500');
                    } else if (['home', 'analysis', 'settings', 'notes'].includes(target)) {
                        btn.classList.remove('text-blue-600');
                        btn.classList.add('text-gray-500');
                    }
                });

                const content = document.getElementById('main-content');
                content.innerHTML = ''; 

                switch(route) {
                    case 'home': this.ui.renderHome(content); break;
                    case 'boxDetail': this.ui.renderBoxDetail(content, params); break;
                    case 'analysis': this.ui.renderAnalysis(content); break;
                    case 'notes': this.ui.renderNotes(content); break;
                    case 'settings': this.ui.renderSettings(content); break;
                }
            }
        }

        /**
         * ------------------------------------------------------------------
         * UIManager
         * ------------------------------------------------------------------
         */
        class UIManager {
            constructor(dataManager) {
                this.db = dataManager;
                this.chartInstance = null;
                this.boxSortKey = 'default';
                this.analysisFilterTag = 'all'; 
                this.applyTheme();
            }

            applyTheme() {
                const s = this.db.data.settings || { fontSize: 'medium', bgColor: '#f3f4f6' };
                const root = document.documentElement;
                root.style.setProperty('--app-bg-color', s.bgColor);
                let scale = '100%';
                if (s.fontSize === 'small') scale = '85%';
                if (s.fontSize === 'large') scale = '115%';
                root.style.setProperty('--app-font-scale', scale);
            }

            renderHome(container) {
                const headerActions = document.getElementById('header-actions');
                headerActions.innerHTML = `
                    <button onclick="ui.openBoxModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-bold shadow transition">
                        <i class="fa-solid fa-plus mr-1"></i>BOXè¿½åŠ 
                    </button>
                `;

                const boxes = this.db.data.boxes;
                if (boxes.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-64 text-gray-400">
                            <i class="fa-solid fa-box-open text-6xl mb-4"></i>
                            <p>ãƒœãƒƒã‚¯ã‚¹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                        </div>
                    `;
                    return;
                }

                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 gap-4 pb-20';
                boxes.forEach(box => {
                    const count = this.db.getLuresByBoxId(box.id).length;
                    const el = document.createElement('div');
                    el.className = 'bg-white rounded-lg shadow overflow-hidden relative group cursor-pointer active:scale-95 transition-transform duration-100';
                    el.onclick = () => router.navigate('boxDetail', box.id);
                    el.innerHTML = `
                        <div class="aspect-square bg-gray-200 relative">
                            ${box.image 
                                ? `<img src="${box.image}" class="w-full h-full object-cover">` 
                                : `<div class="w-full h-full flex items-center justify-center text-gray-400"><i class="fa-solid fa-image text-3xl"></i></div>`
                            }
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-2 pt-6">
                                <div class="text-white text-xs font-bold truncate">${box.note || 'No Title'}</div>
                                <div class="flex gap-1 mt-1 flex-wrap h-5 overflow-hidden">
                                    ${(box.tags || []).slice(0,3).map(t => `<span class="bg-blue-500/80 text-[8px] text-white px-1 rounded">${t}</span>`).join('')}
                                </div>
                            </div>
                            <div class="absolute top-2 right-2 bg-black/60 text-white text-[10px] px-2 py-0.5 rounded-full">${count}å€‹</div>
                        </div>
                    `;
                    grid.appendChild(el);
                });
                container.appendChild(grid);
            }

            renderBoxDetail(container, boxId) {
                const box = this.db.getBox(boxId);
                if (!box) return router.navigate('home');

                document.getElementById('header-actions').innerHTML = `
                    <button onclick="router.navigate('home')" class="text-gray-300 hover:text-white mr-3"><i class="fa-solid fa-arrow-left"></i></button>
                    <button onclick="ui.openBoxModal('${boxId}')" class="text-white hover:text-blue-200 mr-3"><i class="fa-solid fa-pen-to-square"></i></button>
                    <button onclick="ui.deleteBox('${boxId}')" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
                `;

                let lures = [...this.db.getLuresByBoxId(boxId)];

                if (this.boxSortKey === 'sizeDesc') lures.sort((a,b) => (b.length||0) - (a.length||0));
                if (this.boxSortKey === 'sizeAsc') lures.sort((a,b) => (a.length||0) - (b.length||0));
                if (this.boxSortKey === 'weightDesc') lures.sort((a,b) => (b.weight||0) - (a.weight||0));
                if (this.boxSortKey === 'nameAsc') lures.sort((a,b) => (a.name||'').localeCompare(b.name||''));

                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow mb-6 overflow-hidden">
                        <div class="h-48 bg-gray-200 relative group">
                             ${box.image 
                                ? `<img src="${box.image}" class="w-full h-full object-cover">` 
                                : `<div class="w-full h-full flex items-center justify-center"><i class="fa-solid fa-image text-4xl text-gray-300"></i></div>`
                             }
                             <div class="absolute bottom-2 left-2 flex gap-1 flex-wrap">
                                ${(box.tags || []).map(t => `<span class="bg-gray-800/70 text-white text-xs px-2 py-1 rounded">${t}</span>`).join('')}
                             </div>
                        </div>
                        <div class="p-4">
                            <h2 class="font-bold text-lg mb-1">${box.note || 'åç§°æœªè¨­å®š'}</h2>
                            <p class="text-xs text-gray-500">ç™»éŒ²æ—¥: ${Utils.formatDate(box.timestamp)}</p>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-gray-700">ç™»éŒ²ãƒ«ã‚¢ãƒ¼ (${lures.length})</h3>
                        <div class="flex gap-2">
                            <select class="text-xs border rounded bg-white p-1" onchange="ui.setBoxSort(this.value, '${boxId}')">
                                <option value="default" ${this.boxSortKey==='default'?'selected':''}>ç™»éŒ²é †</option>
                                <option value="sizeDesc" ${this.boxSortKey==='sizeDesc'?'selected':''}>å¤§ãã„é †</option>
                                <option value="sizeAsc" ${this.boxSortKey==='sizeAsc'?'selected':''}>å°ã•ã„é †</option>
                                <option value="weightDesc" ${this.boxSortKey==='weightDesc'?'selected':''}>é‡ã„é †</option>
                                <option value="nameAsc" ${this.boxSortKey==='nameAsc'?'selected':''}>åå‰é †</option>
                            </select>
                            <button onclick="ui.openAddLureModal('${boxId}')" class="bg-blue-600 text-white text-xs px-3 py-2 rounded shadow hover:bg-blue-700">
                                <i class="fa-solid fa-plus mr-1"></i>è¿½åŠ 
                            </button>
                        </div>
                    </div>

                    <div class="space-y-3 pb-24">
                        ${lures.map(lure => {
                            const isLost = lure.status === 'ãƒ­ã‚¹ãƒˆ';
                            return `
                            <div class="bg-white p-3 rounded shadow-sm border-l-4 ${isLost ? 'border-gray-400 bg-gray-50 opacity-70' : 'border-blue-500'} flex justify-between items-center" onclick="ui.openEditLureModal('${lure.id}')">
                                <div>
                                    <div class="text-xs text-gray-500 flex gap-2">
                                        <span>${lure.maker}</span>
                                        ${lure.status && lure.status!=='æ‰€æŒ' ? `<span class="bg-gray-200 px-1 rounded text-[10px]">${lure.status}</span>` : ''}
                                    </div>
                                    <div class="font-bold text-sm ${isLost ? 'line-through text-gray-500' : ''}">${lure.name}</div>
                                    <div class="text-xs mt-1 text-gray-600 space-x-2">
                                        <span class="bg-gray-100 px-1 rounded">${lure.type}</span>
                                        <span>${lure.length}mm</span>
                                        <span>${lure.weight}g</span>
                                        ${lure.depth ? `<span>${lure.depth}m</span>` : ''}
                                        ${lure.hookSize ? `<span class="text-xs border border-gray-300 px-1 rounded">#${lure.hookSize}</span>` : ''}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-0.5 rounded mb-1 inline-block">
                                        ${(lure.sinkType||'').split(' ')[0]}
                                    </div>
                                    <div class="text-xs text-gray-400">Ã—${lure.count}</div>
                                </div>
                            </div>
                        `}).join('')}
                        ${lures.length === 0 ? '<div class="text-center text-gray-400 text-sm py-4">ãƒ«ã‚¢ãƒ¼ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>' : ''}
                    </div>
                `;
            }

            setBoxSort(key, boxId) {
                this.boxSortKey = key;
                this.renderBoxDetail(document.getElementById('main-content'), boxId);
            }

            renderAnalysis(container) {
                document.getElementById('header-actions').innerHTML = '';
                const allTags = this.db.getAllTags();

                container.innerHTML = `
                    <div class="bg-white p-4 rounded-lg shadow mb-4">
                        <div class="mb-4 text-sm">
                            <label class="block text-xs text-gray-500 mb-1">ã‚¿ã‚°ã§çµã‚Šè¾¼ã¿</label>
                            <select id="chart-filter" class="w-full bg-blue-50 border border-blue-200 rounded p-2 text-blue-900 font-bold" onchange="ui.updateChart()">
                                <option value="all">ã™ã¹ã¦ã®ãƒ«ã‚¢ãƒ¼ã‚’è¡¨ç¤º</option>
                                ${allTags.map(t => `<option value="${t}" ${this.analysisFilterTag===t?'selected':''}>${t}</option>`).join('')}
                            </select>
                        </div>

                        <div class="flex gap-2 mb-4 text-sm">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Xè»¸</label>
                                <select id="chart-x" class="w-full bg-gray-50 border rounded p-1" onchange="ui.updateChart()">
                                    <option value="length" selected>é•·ã• (mm)</option>
                                    <option value="weight">é‡ã• (g)</option>
                                    <option value="depth">æ·±åº¦ (m)</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Yè»¸</label>
                                <select id="chart-y" class="w-full bg-gray-50 border rounded p-1" onchange="ui.updateChart()">
                                    <option value="length">é•·ã• (mm)</option>
                                    <option value="weight" selected>é‡ã• (g)</option>
                                    <option value="depth">æ·±åº¦ (m)</option>
                                </select>
                            </div>
                        </div>
                        <div class="relative w-full h-64">
                            <canvas id="lureChart"></canvas>
                        </div>
                    </div>
                    <div id="chart-detail" class="hidden bg-white border border-blue-200 p-3 rounded shadow animate-pulse"></div>
                `;
                setTimeout(() => this.updateChart(), 100);
            }

            updateChart() {
                this.analysisFilterTag = document.getElementById('chart-filter').value;
                const xKey = document.getElementById('chart-x').value;
                const yKey = document.getElementById('chart-y').value;
                const ctx = document.getElementById('lureChart').getContext('2d');
                
                let lures = this.db.getAllLures();
                if (this.analysisFilterTag !== 'all') {
                    const targetBoxIds = this.db.data.boxes
                        .filter(b => (b.tags || []).includes(this.analysisFilterTag))
                        .map(b => b.id);
                    lures = lures.filter(l => targetBoxIds.includes(l.boxId));
                }

                const datasets = [];
                const types = [...new Set(lures.map(l => l.sinkType || 'Unknown'))];
                const colors = { 'F (ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)': '#3b82f6', 'S (ã‚·ãƒ³ã‚­ãƒ³ã‚°)': '#ef4444', 'SP (ã‚µã‚¹ãƒšãƒ³ãƒ‰)': '#eab308', 'HS (ãƒ˜ãƒ“ãƒ¼ã‚·ãƒ³ã‚­ãƒ³ã‚°)': '#9333ea', 'Unknown': '#9ca3af' };

                types.forEach(type => {
                    datasets.push({
                        label: type,
                        data: lures.filter(l => (l.sinkType||'Unknown') === type).map(l => ({ x: Number(l[xKey]), y: Number(l[yKey]), lure: l })),
                        backgroundColor: colors[type] || colors['Unknown'],
                        pointRadius: 6
                    });
                });

                if (this.chartInstance) this.chartInstance.destroy();
                this.chartInstance = new Chart(ctx, {
                    type: 'scatter',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { x: { title: { display: true, text: xKey } }, y: { title: { display: true, text: yKey } } },
                        onClick: (e, elements) => {
                            if (elements.length > 0) {
                                const dIdx = elements[0].datasetIndex;
                                const idx = elements[0].index;
                                const l = this.chartInstance.data.datasets[dIdx].data[idx].lure;
                                const det = document.getElementById('chart-detail');
                                det.classList.remove('hidden');
                                det.innerHTML = `
                                    <div class="font-bold text-blue-800">${l.name}</div>
                                    <div class="text-xs text-gray-600 mb-1">${l.maker} / ${l.color}</div>
                                    <div class="text-xs font-mono bg-gray-100 p-1 inline-block rounded">L:${l.length}mm / W:${l.weight}g / D:${l.depth}m</div>
                                    ${l.status && l.status!=='æ‰€æŒ' ? `<div class="mt-1 text-xs text-red-500 font-bold">${l.status}</div>` : ''}
                                `;
                            }
                        }
                    }
                });
            }

            // --- Notes / Guide ---
            renderNotes(container) {
                document.getElementById('header-actions').innerHTML = '';
                container.innerHTML = `
                    <div class="space-y-6 pb-20">
                        <section class="bg-white p-4 rounded shadow">
                            <h3 class="font-bold text-gray-700 mb-3 border-b pb-2 flex items-center">
                                <i class="fa-solid fa-book-open mr-2 text-blue-500"></i>ã‚¢ãƒ—ãƒªã®ä½¿ã„æ–¹
                            </h3>
                            <div class="text-sm text-gray-600 space-y-3">
                                <div>
                                    <span class="font-bold text-blue-800 block mb-1">1. ãƒœãƒƒã‚¯ã‚¹ã‚’ç™»éŒ²ã™ã‚‹</span>
                                    <p>ã€Œãƒœãƒƒã‚¯ã‚¹ã€ã‚¿ãƒ–å³ä¸Šã®<span class="bg-blue-500 text-white text-[10px] px-1 rounded">ï¼‹</span>ãƒœã‚¿ãƒ³ã‹ã‚‰ã€æ‰‹æŒã¡ã®ãƒ«ã‚¢ãƒ¼ã‚±ãƒ¼ã‚¹ã”ã¨ã®å†™çœŸã‚’ç™»éŒ²ã—ã¾ã™ã€‚ã‚¿ã‚°ï¼ˆæµ·ã€å·ãªã©ï¼‰ã‚’ä»˜ã‘ã‚‹ã¨å¾Œã§æ¢ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚</p>
                                </div>
                                <div>
                                    <span class="font-bold text-blue-800 block mb-1">2. ãƒ«ã‚¢ãƒ¼ã‚’è©³ç´°ç™»éŒ²ã™ã‚‹</span>
                                    <p>ç™»éŒ²ã—ãŸãƒœãƒƒã‚¯ã‚¹è©³ç´°ç”»é¢ã§ã€Œå€‹åˆ¥ç™»éŒ²ã€ã‚’è¡Œã„ã¾ã™ã€‚ä¸€åº¦è©³ç´°ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€æ¬¡å›ç™»éŒ²æ™‚ã«<span class="bg-green-100 text-green-800 text-[10px] px-1 rounded">ã‚³ãƒ”ãƒ¼</span>ãƒœã‚¿ãƒ³ã§ã‚¹ãƒšãƒƒã‚¯ã‚’è¤‡è£½ã§ãã‚‹ãŸã‚ã€è‰²é•ã„ã®ç™»éŒ²ãŒã‚¹ãƒ ãƒ¼ã‚ºã§ã™ã€‚</p>
                                </div>
                                <div>
                                    <span class="font-bold text-blue-800 block mb-1">3. æˆ¦åŠ›ã‚’åˆ†æã™ã‚‹</span>
                                    <p>ã€Œåˆ†æã€ã‚¿ãƒ–ã§ãƒ«ã‚¢ãƒ¼ã®åˆ†å¸ƒå›³ï¼ˆé‡ã•Ã—é•·ã•ã€æ·±ã•Ã—é‡ã•ãªã©ï¼‰ã‚’ç¢ºèªã§ãã¾ã™ã€‚æ‰‹æŒã¡ãƒ«ã‚¢ãƒ¼ã®åã‚Šã‚„ã€è¶³ã‚Šãªã„ãƒ¬ãƒ³ã‚¸ãŒä¸€ç›®ã§ã‚ã‹ã‚Šã¾ã™ã€‚</p>
                                </div>
                                <div>
                                    <span class="font-bold text-blue-800 block mb-1">4. ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</span>
                                    <p>ã€Œè¨­å®šã€ã‚¿ãƒ–ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã®ã€Œæ›¸ãå‡ºã—ã€ãŒå¯èƒ½ã§ã™ã€‚æ©Ÿç¨®å¤‰æ›´ã®éš›ã¯JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚</p>
                                </div>
                            </div>
                        </section>

                        <section class="bg-red-50 p-4 rounded shadow border border-red-100">
                            <h3 class="font-bold text-red-700 mb-3 border-b border-red-200 pb-2 flex items-center">
                                <i class="fa-solid fa-triangle-exclamation mr-2"></i>é‡£ã‚Šã®æ³¨æ„ç‚¹
                            </h3>
                            <ul class="text-sm text-gray-700 space-y-2 list-disc list-inside">
                                <li><span class="font-bold">å®‰å…¨ç¬¬ä¸€ï¼š</span>ãƒ©ã‚¤ãƒ•ã‚¸ãƒ£ã‚±ãƒƒãƒˆã‚’ç€ç”¨ã—ã¾ã—ã‚‡ã†ã€‚è¶³å ´ã®æ‚ªã„å ´æ‰€ã§ã¯ã‚¹ãƒ‘ã‚¤ã‚¯ã‚·ãƒ¥ãƒ¼ã‚ºç­‰ã‚’è£…å‚™ã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€ã§ãã‚‹ã ã‘çŸ¥ã‚Šåˆã„ã¨è¤‡æ•°äººã§é‡£è¡Œã¸å‘ã‹ã„ã¾ã—ã‚‡ã†ã€‚</li>
                                <li><span class="font-bold">å¤©å€™ç¢ºèªï¼š</span>é¢¨é€Ÿã€æ³¢ã®é«˜ã•ã€æ½®ä½ã‚’äº‹å‰ã«ç¢ºèªã—ã€ç„¡ç†ãªé‡£è¡Œã¯æ§ãˆã¾ã—ã‚‡ã†ã€‚æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã¯ç‰¹ã«æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚é›¨ã§æ¿¡ã‚Œã‚‹ã¨æ»‘ã‚‹è¶³å ´ã‚‚ã‚ã‚Šã¾ã™ã€‚</li>
                                <li><span class="font-bold">ãƒãƒŠãƒ¼ã‚’å®ˆã‚‹ï¼š</span>ã‚´ãƒŸã¯æŒã¡å¸°ã‚Šã¾ã—ã‚‡ã†ã€‚ãƒ•ãƒƒã‚¯ã€ãƒ©ã‚¤ãƒ³ã€é‰›ã§å‘½ã‚’è½ã¨ã™ç”Ÿç‰©ãŒãŸãã•ã‚“ã„ã¾ã™ã€‚é‡£ã‚Šç¦æ­¢ã‚¨ãƒªã‚¢ã‚„ç«‹ã¡å…¥ã‚Šç¦æ­¢åŒºåŸŸã«ã¯å…¥ã‚‰ãªã„ã§ãã ã•ã„ã€‚</li>
                                <li><span class="font-bold">ãƒ•ãƒƒã‚¯äº‹æ•…ï¼š</span>ãƒ«ã‚¢ãƒ¼ãŒè¡£æœã‚„èº«ä½“ã«åˆºã•ã‚‹äº‹æ•…ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚å¸½å­ã‚„ã‚¢ã‚¤ã‚¦ã‚§ã‚¢ï¼ˆåå…‰ã‚°ãƒ©ã‚¹ï¼‰ã®ç€ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚é‡£ã‚Šå…¬åœ’ç­‰ã§ã¯ä»–ã®é‡£ã‚Šäººã‚„å­ä¾›é€£ã‚Œã®æ–¹ã¸æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚</li>
                            </ul>
                        </section>

                        <section class="bg-teal-50 p-4 rounded shadow border border-teal-100">
                            <h3 class="font-bold text-teal-700 mb-3 border-b border-teal-200 pb-2 flex items-center">
                                <i class="fa-solid fa-hand-holding-heart mr-2"></i>é­šã¨è‡ªç„¶ã¸ã®é…æ…®
                            </h3>
                            <div class="text-sm text-gray-700 space-y-4">
                                <div>
                                    <h4 class="font-bold text-teal-800 mb-1">ğŸŸ å¸Œå°‘ãªé­šã‚’å®ˆã‚‹ãŸã‚ã«</h4>
                                    <p class="mb-2 text-xs text-gray-600">æ•°ãŒæ¸›ã£ã¦ã„ã‚‹é­šç¨®ã«ã¤ã„ã¦ã¯ã€é•·ãé‡£ã‚Šã‚’æ¥½ã—ã‚€ãŸã‚ã«ã‚‚å„ªã—ã„å¯¾å¿œã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†ã€‚</p>
                                    <ul class="list-disc list-inside space-y-1 pl-1">
                                        <li><span class="font-bold">é‡£è¡Œå›æ•°ã‚„ã‚­ãƒ¼ãƒ—æ•°ã®èª¿æ•´ï¼š</span>ç‹™ã†é­šç¨®ã‚’è»¢æ›ã—ãŸã‚Šã€ãƒªãƒªãƒ¼ã‚¹ã®å‰²åˆã‚’å¢—ã‚„ã™ãªã©ã—ã¦ã€å€‹ä½“æ•°ç¶­æŒã«å”åŠ›ã—ã¾ã—ã‚‡ã†ã€‚</li>
                                        <li><span class="font-bold">ãƒ€ãƒ¡ãƒ¼ã‚¸ã®è»½æ¸›ï¼š</span>ãƒãƒ¼ãƒ–ãƒ¬ã‚¹ãƒ•ãƒƒã‚¯ï¼ˆã‚«ã‚¨ã‚·ãªã—ï¼‰ã®ä½¿ç”¨ã‚„ã€æ¿¡ã‚‰ã—ãŸæ‰‹ã§è§¦ã‚Œã‚‹ãªã©ã€é­šä½“ã¸ã®è² æ‹…ã‚’æ¸›ã‚‰ã—ã¾ã—ã‚‡ã†ã€‚</li>
                                        <li><span class="font-bold">ç¹æ®–æœŸã¸ã®é…æ…®ï¼š</span>ç”£åµæœŸãªã©ã€é­šãŒãƒ‡ãƒªã‚±ãƒ¼ãƒˆãªæ™‚æœŸã¯é‡£ã‚Šã‚’æ§ãˆã‚‹ã€ã‚ã‚‹ã„ã¯å ´æ‰€ã‚’å¤‰ãˆã‚‹ãªã©ã®é…æ…®ã‚‚å¤§åˆ‡ã§ã™ã€‚</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="font-bold text-teal-800 mb-1">ğŸŒ¿ å¤–æ¥ç¨®ãƒ»ç”Ÿæ…‹ç³»ã«ã¤ã„ã¦</h4>
                                    <p class="mb-2 text-xs text-gray-600">åœ°åŸŸã®ç”Ÿæ…‹ç³»ã‚’å®ˆã‚‹ãŸã‚ã€é©åˆ‡ãªè¡Œå‹•ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</p>
                                    <ul class="list-disc list-inside space-y-1 pl-1">
                                        <li><span class="font-bold">æŒã¡å‡ºã—ãƒ»æ”¾æµã®ç¦æ­¢ï¼š</span>ç”ŸããŸã¾ã¾ã®ç§»å‹•ã‚„ã€é‡£ã£ãŸå ´æ‰€ã¨ã¯é•ã†å ´æ‰€ã¸ã®æ”¾æµã¯æ³•å¾‹ã§ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚</li>
                                        <li><span class="font-bold">ãƒªãƒªãƒ¼ã‚¹ã¨ã‚­ãƒ¼ãƒ—ï¼š</span>å¤–æ¥ç¨®ã®å ´åˆã€ç”Ÿæ…‹ç³»ä¿è­·ã®è¦³ç‚¹ã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ã›ãšã«ã‚­ãƒ¼ãƒ—ï¼ˆæŒã¡å¸°ã‚Šï¼‰ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</li>
                                        <li><span class="font-bold">æƒ…å ±ã®å…±æœ‰ï¼š</span>è¦‹æ…£ã‚Œãªã„é­šãŒé‡£ã‚ŒãŸéš›ã¯ã€ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹å‰ã«å†™çœŸã‚’æ’®ã‚Šã€å°‚é–€æ©Ÿé–¢ç­‰ã¸å ±å‘Šãƒ»ç›¸è«‡ã—ã¾ã—ã‚‡ã†ã€‚</li>
                                    </ul>
                                </div>
                            </div>
                        </section>
                    </div>
                `;
            }

            // --- Settings ---
            renderSettings(container) {
                document.getElementById('header-actions').innerHTML = '';
                const master = this.db.data.master;
                const settings = this.db.data.settings || {};

                container.innerHTML = `
                    <div class="space-y-6 pb-20">
                        <section class="bg-white p-4 rounded shadow">
                            <h3 class="font-bold text-gray-700 mb-3 border-b pb-2"><i class="fa-solid fa-paintbrush mr-2"></i>è¡¨ç¤ºè¨­å®š</h3>
                            <div class="mb-4">
                                <label class="block text-xs font-bold text-gray-600 mb-1">æ–‡å­—ã‚µã‚¤ã‚º</label>
                                <div class="flex gap-2">
                                    ${['small', 'medium', 'large'].map(s => `
                                        <button onclick="ui.changeSetting('fontSize', '${s}')" class="flex-1 py-2 rounded text-xs border ${settings.fontSize===s ? 'bg-blue-600 text-white border-blue-600' : 'bg-gray-50 text-gray-600 border-gray-200'}">
                                            ${s==='small'?'å°':s==='medium'?'ä¸­':'å¤§'}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="mb-2">
                                <label class="block text-xs font-bold text-gray-600 mb-1">èƒŒæ™¯è‰²</label>
                                <div class="flex gap-2">
                                    ${['#f3f4f6', '#ffffff', '#e0f2fe', '#fff7ed'].map(c => `
                                        <button onclick="ui.changeSetting('bgColor', '${c}')" class="w-8 h-8 rounded-full border-2 ${settings.bgColor===c ? 'border-blue-600 scale-110 shadow-md' : 'border-transparent'}" style="background-color: ${c};"></button>
                                    `).join('')}
                                </div>
                            </div>
                        </section>

                        <section class="bg-white p-4 rounded shadow">
                            <h3 class="font-bold text-gray-700 mb-3 border-b pb-2"><i class="fa-solid fa-database mr-2"></i>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="db.exportData()" class="bg-green-600 text-white py-2 rounded text-sm hover:bg-green-700"><i class="fa-solid fa-file-export mr-1"></i>æ›¸ãå‡ºã—</button>
                                <label class="bg-orange-500 text-white py-2 rounded text-center text-sm hover:bg-orange-600 cursor-pointer">
                                    <i class="fa-solid fa-file-import mr-1"></i>èª­ã¿è¾¼ã¿
                                    <input type="file" class="hidden" onchange="ui.handleImport(this)">
                                </label>
                            </div>
                        </section>

                        <section class="bg-white p-4 rounded shadow">
                            <h3 class="font-bold text-gray-700 mb-3 border-b pb-2"><i class="fa-solid fa-list-check mr-2"></i>ãƒã‚¹ã‚¿ç·¨é›†</h3>
                            <p class="text-[10px] text-gray-400 mb-2">â€»ã‚«ãƒ³ãƒ(,)åŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                            ${this.renderMasterEditor('manufacturers', 'ãƒ¡ãƒ¼ã‚«ãƒ¼å', master.manufacturers)}
                            ${this.renderMasterEditor('types', 'ãƒ«ã‚¢ãƒ¼ã‚¿ã‚¤ãƒ—', master.types)}
                            ${this.renderMasterEditor('fields', 'ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰', master.fields)}
                            ${this.renderMasterEditor('targets', 'å¯¾è±¡é­š', master.targets)}
                        </section>
                    </div>
                `;
            }

            changeSetting(key, val) {
                this.db.updateSettings({ [key]: val });
                this.applyTheme();
                this.renderSettings(document.getElementById('main-content'));
            }

            renderMasterEditor(key, title, list) {
                return `
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-600 mb-1">${title}</label>
                        <textarea id="master-${key}" class="w-full text-xs border rounded p-2 bg-gray-50" rows="3">${list.join(', ')}</textarea>
                        <button onclick="ui.saveMaster('${key}')" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded mt-1">æ›´æ–°</button>
                    </div>
                `;
            }

            saveMaster(key) {
                const val = document.getElementById(`master-${key}`).value;
                this.db.updateMaster(key, val.split(',').map(s => s.trim()).filter(s => s));
                Utils.showToast(`${key}ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
            }

            handleImport(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (this.db.importData(e.target.result)) {
                        alert('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
                        location.reload();
                    }
                };
                reader.readAsText(file);
            }

            // --- Modals ---
            
            openBoxModal(boxId = null) {
                const master = this.db.data.master;
                const isEdit = !!boxId;
                const box = isEdit ? this.db.getBox(boxId) : { note: '', tags: [], image: null };
                const boxTags = box.tags || [];

                const createTagSection = (title, items) => `
                    <div class="mb-3">
                        <label class="block text-xs font-bold mb-1 text-gray-500">${title}</label>
                        <div class="flex flex-wrap gap-2">
                            ${items.map(t => `
                                <label class="inline-flex items-center">
                                    <input type="checkbox" value="${t}" class="hidden peer box-tag-input" ${boxTags.includes(t) ? 'checked' : ''}>
                                    <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full cursor-pointer peer-checked:bg-blue-500 peer-checked:text-white transition select-none">${t}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;

                const content = `
                    <div class="p-4">
                        <h3 class="font-bold text-lg mb-4">${isEdit ? 'ãƒœãƒƒã‚¯ã‚¹ç·¨é›†' : 'æ–°ã—ã„ãƒœãƒƒã‚¯ã‚¹'}</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">å†™çœŸ</label>
                            <label class="block w-full h-32 border-2 border-dashed border-gray-300 rounded flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50 image-preview bg-center bg-cover bg-no-repeat" 
                                   id="box-img-preview" 
                                   style="${box.image ? `background-image: url(${box.image})` : ''}"
                                   data-base64="${box.image || ''}">
                                ${!box.image ? `<i class="fa-solid fa-camera text-2xl text-gray-400 mb-1"></i><span class="text-xs text-gray-400">ã‚¿ãƒƒãƒ—ã—ã¦æ’®å½±/é¸æŠ</span>` : ''}
                                <input type="file" accept="image/*" class="hidden" onchange="ui.handleImagePreview(this, 'box-img-preview')">
                            </label>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">ãƒ¡ãƒ¢ / ã‚¿ã‚¤ãƒˆãƒ«</label>
                            <input type="text" id="box-note" class="w-full border rounded p-2" value="${box.note}">
                        </div>

                        <div class="mb-4 max-h-60 overflow-y-auto border-t border-b py-2">
                            ${createTagSection('ãƒ«ã‚¢ãƒ¼ã‚¿ã‚¤ãƒ—', master.types)}
                            ${createTagSection('æµ®åŠ›ã‚¿ã‚¤ãƒ—', master.sinkTypes)}
                            ${createTagSection('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰', master.fields)}
                            ${createTagSection('å¯¾è±¡é­š', master.targets)}
                        </div>

                        <div class="flex gap-2">
                            <button onclick="ui.closeModal()" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="ui.submitBox('${boxId || ''}')" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold">${isEdit ? 'æ›´æ–°' : 'ç™»éŒ²'}</button>
                        </div>
                    </div>
                `;
                this.showModal(content);
            }

            async handleImagePreview(input, targetId) {
                if (input.files && input.files[0]) {
                    const compressed = await Utils.compressImage(input.files[0]);
                    const el = document.getElementById(targetId);
                    el.style.backgroundImage = `url(${compressed})`;
                    el.dataset.base64 = compressed;
                    el.innerHTML = '';
                }
            }

            submitBox(boxId) {
                const imgData = document.getElementById('box-img-preview').dataset.base64 || null;
                const note = document.getElementById('box-note').value;
                const tags = Array.from(document.querySelectorAll('.box-tag-input:checked')).map(cb => cb.value);

                if (!imgData && !note) {
                    alert('å†™çœŸã‹ãƒ¡ãƒ¢ã®ã©ã¡ã‚‰ã‹ã¯å¿…é ˆã§ã™');
                    return;
                }

                if (boxId) {
                    const oldBox = this.db.getBox(boxId);
                    this.db.updateBox({
                        ...oldBox,
                        image: imgData,
                        note: note,
                        tags: tags
                    });
                    Utils.showToast('ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    this.closeModal();
                    this.renderBoxDetail(document.getElementById('main-content'), boxId);
                } else {
                    this.db.addBox({
                        id: Utils.uuid(),
                        image: imgData,
                        note: note,
                        tags: tags,
                        timestamp: Date.now()
                    });
                    Utils.showToast('ãƒœãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¾ã—ãŸ');
                    this.closeModal();
                    this.renderHome(document.getElementById('main-content'));
                }
            }

            deleteBox(id) {
                if(confirm('ã“ã®ãƒœãƒƒã‚¯ã‚¹ã¨ä¸­ã®ãƒ«ã‚¢ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    this.db.deleteBox(id);
                    router.navigate('home');
                }
            }

            // Lure Modal
            openAddLureModal(boxId, copyFromLure = null) {
                const master = this.db.data.master;
                const last = !copyFromLure && sessionStorage.getItem('last_lure') ? JSON.parse(sessionStorage.getItem('last_lure')) : null;
                const l = copyFromLure || last || { 
                    name:'', maker:'', type:'', sinkType:'F (ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)', 
                    length:'', weight:'', depth:'', color:'', count:1,
                    hookSize:'', status:'æ‰€æŒ', purchaseDate: Utils.getTodayString()
                };
                
                const content = `
                    <div class="p-4">
                        <h3 class="font-bold text-lg mb-4">ãƒ«ã‚¢ãƒ¼è©³ç´°ç™»éŒ²</h3>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div><label class="text-xs text-gray-500">ãƒ¡ãƒ¼ã‚«ãƒ¼</label><select id="lure-maker" class="w-full border p-1 rounded"><option value="">é¸æŠ</option>${master.manufacturers.map(m=>`<option ${l.maker===m?'selected':''}>${m}</option>`).join('')}</select></div>
                            <div><label class="text-xs text-gray-500">å•†å“å</label><input type="text" id="lure-name" class="w-full border p-1 rounded" value="${l.name}"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div><label class="text-xs text-gray-500">ã‚¿ã‚¤ãƒ—</label><select id="lure-type" class="w-full border p-1 rounded">${master.types.map(t=>`<option ${l.type===t?'selected':''}>${t}</option>`).join('')}</select></div>
                            <div><label class="text-xs text-gray-500">æµ®åŠ›</label><select id="lure-sink" class="w-full border p-1 rounded">${master.sinkTypes.map(t=>`<option ${l.sinkType===t?'selected':''}>${t}</option>`).join('')}</select></div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <div><label class="text-xs text-gray-500">é•·ã•(mm)</label><input type="number" step="5" id="lure-len" class="w-full border p-1 rounded" value="${l.length}"></div>
                            <div><label class="text-xs text-gray-500">é‡ã•(g)</label><input type="number" id="lure-wgt" class="w-full border p-1 rounded" value="${l.weight}"></div>
                            <div><label class="text-xs text-gray-500">æ·±åº¦(m)</label><input type="number" step="0.5" id="lure-dep" class="w-full border p-1 rounded" value="${l.depth}"></div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <div><label class="text-xs text-gray-500">ãƒ•ãƒƒã‚¯</label><input type="text" id="lure-hook" class="w-full border p-1 rounded" placeholder="#6" value="${l.hookSize||''}"></div>
                            <div class="col-span-2"><label class="text-xs text-gray-500">çŠ¶æ…‹</label>
                                <select id="lure-status" class="w-full border p-1 rounded">
                                    <option ${l.status==='æ‰€æŒ'?'selected':''}>æ‰€æŒ</option>
                                    <option ${l.status==='ãƒ­ã‚¹ãƒˆ'?'selected':''}>ãƒ­ã‚¹ãƒˆ</option>
                                    <option ${l.status==='è³¼å…¥äºˆå®š'?'selected':''}>è³¼å…¥äºˆå®š</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div><label class="text-xs text-gray-500">ã‚«ãƒ©ãƒ¼</label><input type="text" id="lure-color" class="w-full border p-1 rounded" value="${l.color}"></div>
                            <div><label class="text-xs text-gray-500">è³¼å…¥æ—¥</label><input type="date" id="lure-date" class="w-full border p-1 rounded" value="${l.purchaseDate || Utils.getTodayString()}"></div>
                        </div>
                         <div class="mb-4">
                            <label class="text-xs text-gray-500">å€‹æ•°</label>
                            <input type="number" id="lure-count" class="w-full border p-1 rounded" value="${l.count}">
                        </div>

                        <div class="flex gap-2">
                            <button onclick="ui.closeModal()" class="flex-1 bg-gray-200 py-2 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="ui.submitLure('${boxId}')" class="flex-1 bg-blue-600 text-white py-2 rounded">ç™»éŒ²</button>
                        </div>
                    </div>
                `;
                this.showModal(content);
            }

            submitLure(boxId) {
                const lure = {
                    id: Utils.uuid(), boxId: boxId,
                    maker: document.getElementById('lure-maker').value,
                    name: document.getElementById('lure-name').value,
                    type: document.getElementById('lure-type').value,
                    sinkType: document.getElementById('lure-sink').value,
                    length: document.getElementById('lure-len').value,
                    weight: document.getElementById('lure-wgt').value,
                    depth: document.getElementById('lure-dep').value,
                    color: document.getElementById('lure-color').value,
                    count: document.getElementById('lure-count').value,
                    hookSize: document.getElementById('lure-hook').value,
                    status: document.getElementById('lure-status').value,
                    purchaseDate: document.getElementById('lure-date').value
                };
                sessionStorage.setItem('last_lure', JSON.stringify(lure));
                this.db.addLure(lure);
                this.closeModal();
                this.renderBoxDetail(document.getElementById('main-content'), boxId);
            }

            openEditLureModal(lureId) {
                const lure = this.db.data.lures.find(l => l.id === lureId);
                const content = `
                    <div class="p-4 text-center">
                        <h3 class="font-bold mb-1">${lure.name}</h3>
                        <div class="text-xs text-gray-500 mb-4">è³¼å…¥æ—¥: ${lure.purchaseDate || '-'} / ãƒ•ãƒƒã‚¯: ${lure.hookSize || 'æœªç™»éŒ²'}</div>
                        
                        <div class="flex flex-col gap-2">
                            <button onclick="ui.copyAndAdd('${lureId}')" class="bg-blue-100 text-blue-800 py-2 rounded">ã‚¹ãƒšãƒƒã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æ–°è¦</button>
                            <button onclick="ui.deleteLure('${lureId}', '${lure.boxId}')" class="bg-red-100 text-red-600 py-2 rounded">å‰Šé™¤</button>
                            <button onclick="ui.closeModal()" class="text-gray-500 mt-2">é–‰ã˜ã‚‹</button>
                        </div>
                    </div>
                `;
                this.showModal(content);
            }

            deleteLure(id, boxId) {
                if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    this.db.deleteLure(id);
                    this.closeModal();
                    this.renderBoxDetail(document.getElementById('main-content'), boxId);
                }
            }

            copyAndAdd(id) {
                const lure = this.db.data.lures.find(l => l.id === id);
                this.closeModal();
                setTimeout(() => this.openAddLureModal(lure.boxId, lure), 200);
            }

            showModal(html) {
                const c = document.getElementById('modal-container');
                c.innerHTML = html;
                document.getElementById('modal-overlay').classList.remove('hidden');
                c.classList.add('modal-enter');
                setTimeout(() => c.classList.add('modal-enter-active'), 10);
            }
            closeModal() {
                const c = document.getElementById('modal-container');
                c.classList.remove('modal-enter-active');
                c.classList.add('modal-exit-active');
                setTimeout(() => {
                    document.getElementById('modal-overlay').classList.add('hidden');
                    c.classList.remove('modal-exit-active');
                    c.innerHTML = '';
                }, 200);
            }
        }

        const db = new DataManager();
        const ui = new UIManager(db);
        const router = new AppRouter(ui);
        document.addEventListener('DOMContentLoaded', () => router.navigate('home'));

    </script>
</body>
</html>